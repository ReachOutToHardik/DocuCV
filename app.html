<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuCV Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: {
                        space: { 950: '#030305', 900: '#0A0A0F', 800: '#12121A', 700: '#1C1C26' },
                        accent: { 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5' }
                    },
                    backgroundImage: {
                        'nebula': 'radial-gradient(circle at 50% -20%, #2e1065 0%, #030305 45%)',
                        'grid': "url('https://grainy-gradients.vercel.app/noise.svg')"
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #030305;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass:hover {
            border-color: rgba(99, 102, 241, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0A0A0F;
        }

        ::-webkit-scrollbar-thumb {
            background: #1C1C26;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2d3748;
        }
    </style>
</head>

<body x-data="app()" x-init="initApp()" class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-space-900 border-r border-white/5 flex flex-col">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-accent-600 rounded-lg flex items-center justify-center text-white">
                <i class="fa-solid fa-file-lines"></i>
            </div>
            <span class="font-display font-bold text-xl tracking-wide text-white">Docu<span
                    class="text-accent-500">CV</span></span>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-4">
            <a href="#" @click.prevent="currentTab = 'builder'"
                :class="currentTab === 'builder' ? 'bg-accent-500/10 text-accent-400 border-accent-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-white border-transparent'"
                class="flex items-center gap-3 px-4 py-3 rounded-xl border transition font-medium">
                <i class="fa-solid fa-wand-magic-sparkles w-5"></i> Builder
            </a>
            <a href="#" @click.prevent="currentTab = 'ats'"
                :class="currentTab === 'ats' ? 'bg-accent-500/10 text-accent-400 border-accent-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-white border-transparent'"
                class="flex items-center gap-3 px-4 py-3 rounded-xl border transition font-medium">
                <i class="fa-solid fa-bullseye w-5"></i> ATS Scanner
            </a>
            <a href="#" @click.prevent="currentTab = 'templates'"
                :class="currentTab === 'templates' ? 'bg-accent-500/10 text-accent-400 border-accent-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-white border-transparent'"
                class="flex items-center gap-3 px-4 py-3 rounded-xl border transition font-medium">
                <i class="fa-solid fa-layer-group w-5"></i> Templates
            </a>
            <a href="#" @click.prevent="currentTab = 'cover-letter'"
                :class="currentTab === 'cover-letter' ? 'bg-accent-500/10 text-accent-400 border-accent-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-white border-transparent'"
                class="flex items-center gap-3 px-4 py-3 rounded-xl border transition font-medium">
                <i class="fa-solid fa-envelope-open-text w-5"></i> Cover Letter
            </a>
        </nav>

        <div class="p-4 border-t border-white/5">
            <div class="glass rounded-xl p-4 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-400 uppercase">Credits</span>
                    <span class="text-xs font-bold text-white" x-text="user ? user.credits + ' left' : '...'"></span>
                </div>
                <div class="w-full bg-space-950 rounded-full h-1.5">
                    <div class="bg-accent-500 h-1.5 rounded-full"
                        :style="'width: ' + (user ? user.credits / 5 * 100 : 0) + '%'">
                    </div>
                </div>
                <a href="pricing.html"
                    class="block mt-3 text-center text-xs text-accent-400 hover:text-white transition font-bold">Upgrade
                    to Pro</a>
            </div>

            <div class="flex items-center gap-3 px-2" x-show="user">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs"
                    x-text="getInitials()"></div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate" x-text="user.full_name || 'User'"></p>
                    <p class="text-xs text-gray-500 truncate" x-text="user.email"></p>
                </div>
                <button @click="logout()" class="text-gray-500 hover:text-white transition"><i
                        class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Header -->
        <header
            class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-space-950/50 backdrop-blur-sm z-10">
            <h1 class="font-display font-bold text-xl text-white" x-text="tabTitle"></h1>
            <div class="flex items-center gap-4">
                <button
                    class="w-8 h-8 rounded-full bg-space-800 flex items-center justify-center text-gray-400 hover:text-white transition"><i
                        class="fa-regular fa-bell"></i></button>
            </div>
        </header>

        <!-- Scrollable Area -->
        <div class="flex-1 overflow-y-auto p-8 relative">
            <div class="absolute inset-0 bg-nebula z-0 pointer-events-none"></div>
            <div class="absolute inset-0 opacity-20 bg-grid z-0 pointer-events-none"></div>

            <!-- BUILDER TAB -->
            <div x-show="currentTab === 'builder'" class="max-w-4xl mx-auto relative z-10">
                <div class="glass p-8 rounded-2xl mb-8">
                    <h2 class="text-2xl font-display font-bold text-white mb-6">Personal Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">Full Name</label>
                            <input type="text" x-model="formData.name"
                                class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">Email</label>
                            <input type="email" x-model="formData.email"
                                class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">Phone</label>
                            <input type="text" x-model="formData.phone"
                                class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">Target Role</label>
                            <input type="text" x-model="formData.targetRole"
                                class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">LinkedIn</label>
                            <input type="text" x-model="formData.linkedin"
                                class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400 mb-1">GitHub / Portfolio</label>
                            <input type="text" x-model="formData.github"
                                class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-400 mb-1">Profile Picture</label>
                            <input type="file" @change="handleImage" accept="image/*"
                                class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-accent-500/10 file:text-accent-400 hover:file:bg-accent-500/20">
                        </div>
                    </div>
                </div>

                <div class="glass p-8 rounded-2xl mb-8">
                    <h2 class="text-2xl font-display font-bold text-white mb-6">Experience Dump</h2>
                    <p class="text-gray-400 text-sm mb-4">Paste your raw resume or rough notes here. Our AI will
                        structure it, quantify results, and format it perfectly.</p>
                    <textarea x-model="formData.rawInfo" rows="10"
                        class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition"
                        placeholder="e.g. Worked at Google from 2020-2022 as Software Engineer. Built a scalable API..."></textarea>
                </div>

                <div class="flex justify-end">
                    <button @click="generateResume()" :disabled="generating"
                        class="bg-accent-600 hover:bg-accent-500 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-accent-500/25 transition flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-wand-magic-sparkles" :class="{'fa-spin': generating}"></i>
                        <span x-text="generating ? 'Generating Magic...' : 'Generate Resume'"></span>
                    </button>
                </div>
            </div>

            <!-- TEMPLATES TAB -->
            <div x-show="currentTab === 'templates'" class="max-w-6xl mx-auto relative z-10">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="t in templates" :key="t.path">
                        <div class="glass rounded-2xl overflow-hidden group cursor-pointer border-2 transition"
                            :class="selectedTemplate === t.path ? 'border-accent-500' : 'border-transparent hover:border-white/10'"
                            @click="selectedTemplate = t.path">
                            <div class="aspect-[3/4] bg-space-950 relative overflow-hidden">
                                <img :src="t.img || 'https://via.placeholder.com/300x400/12121a/333?text=No+Preview'"
                                    class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500 group-hover:scale-105">
                                <div
                                    class="absolute inset-0 bg-gradient-to-t from-space-950 via-transparent to-transparent opacity-80">
                                </div>
                                <div class="absolute bottom-0 left-0 p-6">
                                    <h3 class="font-bold text-white text-lg" x-text="t.name"></h3>
                                    <p class="text-xs text-gray-400" x-text="t.desc"></p>
                                </div>
                                <div x-show="selectedTemplate === t.path"
                                    class="absolute top-4 right-4 w-8 h-8 bg-accent-500 rounded-full flex items-center justify-center text-white shadow-lg">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- ATS TAB -->
            <div x-show="currentTab === 'ats'" class="max-w-4xl mx-auto relative z-10">
                <div class="glass p-8 rounded-2xl mb-8">
                    <h2 class="text-2xl font-display font-bold text-white mb-6">ATS Scanner</h2>
                    <div class="mb-6">
                        <label class="block text-xs font-medium text-gray-400 mb-1">Upload Resume (PDF/DOCX)</label>
                        <input type="file" @change="atsFile = $event.target.files[0]"
                            class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-accent-500/10 file:text-accent-400 hover:file:bg-accent-500/20">
                    </div>
                    <div class="mb-6">
                        <label class="block text-xs font-medium text-gray-400 mb-1">Job Description</label>
                        <textarea x-model="atsJobDesc" rows="6"
                            class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition"
                            placeholder="Paste the job description here..."></textarea>
                    </div>
                    <button @click="runAtsCheck()" :disabled="atsChecking || !atsFile"
                        class="w-full bg-accent-600 hover:bg-accent-500 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-accent-500/25 transition flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-bullseye" :class="{'fa-spin': atsChecking}"></i>
                        <span x-text="atsChecking ? 'Scanning...' : 'Scan Resume'"></span>
                    </button>
                </div>

                <div x-show="atsResult" class="glass p-8 rounded-2xl border-l-4"
                    :class="atsResult?.score >= 80 ? 'border-green-500' : (atsResult?.score >= 50 ? 'border-yellow-500' : 'border-red-500')">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Analysis Results</h3>
                        <div class="text-3xl font-black"
                            :class="atsResult?.score >= 80 ? 'text-green-500' : (atsResult?.score >= 50 ? 'text-yellow-500' : 'text-red-500')"
                            x-text="atsResult?.score + '/100'"></div>
                    </div>
                    <p class="text-gray-300 mb-6" x-text="atsResult?.summary"></p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-bold text-white mb-3 text-sm uppercase tracking-wider">Missing Keywords</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="kw in atsResult?.keywords?.missing">
                                    <span
                                        class="px-2 py-1 bg-red-500/10 text-red-400 rounded text-xs border border-red-500/20"
                                        x-text="kw"></span>
                                </template>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-3 text-sm uppercase tracking-wider">Matched Keywords</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="kw in atsResult?.keywords?.matched">
                                    <span
                                        class="px-2 py-1 bg-green-500/10 text-green-400 rounded text-xs border border-green-500/20"
                                        x-text="kw"></span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-white mb-3 text-sm uppercase tracking-wider">Recommendations</h4>
                        <ul class="space-y-2">
                            <template x-for="rec in atsResult?.recommendations">
                                <li class="flex items-start gap-3 text-sm text-gray-400">
                                    <i class="fa-solid fa-circle-exclamation text-accent-500 mt-1"></i>
                                    <span x-text="rec"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>

        </div>

        <!-- COVER LETTER TAB -->
        <div x-show="currentTab === 'cover-letter'" class="max-w-4xl mx-auto relative z-10">
            <div class="glass p-8 rounded-2xl mb-8">
                <h2 class="text-2xl font-display font-bold text-white mb-6">AI Cover Letter Generator</h2>
                <p class="text-gray-400 text-sm mb-6">Paste the job description below, and we'll write a tailored cover
                    letter based on your profile.</p>

                <div class="mb-6">
                    <label class="block text-xs font-medium text-gray-400 mb-1">Job Description</label>
                    <textarea x-model="clJobDesc" rows="6"
                        class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition"
                        placeholder="Paste the full job description here..."></textarea>
                </div>

                <button @click="generateCoverLetter()" :disabled="clGenerating || !clJobDesc"
                    class="w-full bg-accent-600 hover:bg-accent-500 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-accent-500/25 transition flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-pen-nib" :class="{'fa-spin': clGenerating}"></i>
                    <span x-text="clGenerating ? 'Writing Letter...' : 'Generate Cover Letter'"></span>
                </button>
            </div>

            <div x-show="clResult" class="glass p-8 rounded-2xl mb-8">
                <h3 class="text-xl font-bold text-white mb-4">Your Cover Letter</h3>
                <textarea x-model="clResult" rows="15"
                    class="w-full bg-space-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-accent-500 transition mb-4"></textarea>
                <div class="flex justify-end gap-4">
                    <button @click="copyToClipboard(clResult)"
                        class="text-gray-400 hover:text-white transition font-medium text-sm"><i
                            class="fa-regular fa-copy"></i> Copy Text</button>
                </div>
            </div>
        </div>

        <!-- PDF MODAL -->
        <div x-show="showPdfModal" class="absolute inset-0 z-50 bg-space-950/90 backdrop-blur-md flex flex-col"
            style="display: none;">
            <div class="h-16 flex items-center justify-between px-8 border-b border-white/10">
                <h2 class="font-display font-bold text-xl text-white">Your Resume</h2>
                <div class="flex items-center gap-4">
                    <a :href="pdfUrl" download="resume.pdf"
                        class="bg-accent-600 hover:bg-accent-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">Download
                        PDF</a>
                    <button @click="showPdfModal = false" class="text-gray-400 hover:text-white transition"><i
                            class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            <iframe :src="pdfUrl" class="flex-1 w-full border-none bg-gray-800"></iframe>
        </div>

    </main>

    <script>
        function app() {
            return {
                // State
                currentTab: 'builder',
                user: null,

                // Data
                formData: {
                    name: '', email: '', phone: '', linkedin: '', github: '',
                    targetRole: '', rawInfo: ''
                },
                profileImage: null,
                templates: [],
                selectedTemplate: 'templates/Star/star.tex', // Default template

                // UI State
                generating: false,
                showPdfModal: false,
                pdfUrl: null,

                // ATS State
                atsFile: null,
                atsJobDesc: '',
                atsChecking: false,
                atsResult: null,

                // Cover Letter State
                clJobDesc: '',
                clGenerating: false,
                clResult: '',

                // Computed
                get tabTitle() {
                    if (this.currentTab === 'builder') return 'Resume Builder';
                    if (this.currentTab === 'templates') return 'Template Gallery';
                    if (this.currentTab === 'ats') return 'ATS Scanner';
                    if (this.currentTab === 'cover-letter') return 'Cover Letter';
                    return 'DocuCV';
                },

                getInitials() {
                    if (!this.user || !this.user.full_name) return 'U';
                    return this.user.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                },

                async initApp() {
                    // 1. Setup Supabase
                    const SUPABASE_URL = 'https://bemxgkzdfqqwlxfsawlm.supabase.co';
                    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlbXhna3pkZnFxd2x4ZnNhd2xtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NzYwMTgsImV4cCI6MjA3OTE1MjAxOH0.AvIux8Yv5WtZw7icPwgoQr1OavcFqpWDO4OAsvwmzj4';
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                    // 2. Check Auth
                    const { data: { session } } = await this.supabase.auth.getSession();
                    if (!session) {
                        window.location.href = '/login.html';
                        return;
                    }
                    this.user = session.user;
                    // Mock user data for display if missing
                    if (!this.user.full_name) this.user.full_name = this.user.user_metadata.full_name || 'User';
                    if (!this.user.credits) this.user.credits = 3;

                    // 3. Load Templates
                    this.fetchTemplates();
                },

                async logout() {
                    await this.supabase.auth.signOut();
                    window.location.href = '/login.html';
                },

                async fetchTemplates() {
                    try {
                        const res = await fetch('/api/templates');
                        this.templates = await res.json();
                    } catch (e) { console.error(e); }
                },

                handleImage(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => this.profileImage = e.target.result;
                        reader.readAsDataURL(file);
                    }
                },

                async generateResume() {
                    this.generating = true;
                    try {
                        const payload = {
                            userData: { ...this.formData, profileImage: this.profileImage },
                            templatePath: this.selectedTemplate
                        };

                        const res = await fetch('/api/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!res.ok) throw new Error((await res.json()).error);

                        const blob = await res.blob();
                        this.pdfUrl = URL.createObjectURL(blob);
                        this.showPdfModal = true;

                    } catch (e) {
                        alert("Generation Failed: " + e.message);
                    } finally {
                        this.generating = false;
                    }
                },

                async runAtsCheck() {
                    this.atsChecking = true;
                    const formData = new FormData();
                    formData.append('resume', this.atsFile);
                    formData.append('jobDescription', this.atsJobDesc);

                    try {
                        const res = await fetch('/api/ats-check', { method: 'POST', body: formData });
                        if (!res.ok) throw new Error("Failed");
                        this.atsResult = await res.json();
                    } catch (e) {
                        alert("ATS Check Failed: " + e.message);
                    } finally {
                        this.atsChecking = false;
                    }
                },

                async generateCoverLetter() {
                    this.clGenerating = true;
                    try {
                        const res = await fetch('/api/cover-letter', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userData: this.formData,
                                jobDescription: this.clJobDesc
                            })
                        });

                        if (!res.ok) throw new Error((await res.json()).error);
                        const data = await res.json();
                        this.clResult = data.coverLetter;

                    } catch (e) {
                        alert("Cover Letter Generation Failed: " + e.message);
                    } finally {
                        this.clGenerating = false;
                    }
                },

                copyToClipboard(text) {
                    navigator.clipboard.writeText(text);
                    alert("Copied to clipboard!");
                }
            }
        }
    </script>
</body>

</html>